version: 1.0.1
component: test

failImmediatelyOnError: true

timeoutInSeconds: 36000

env:
  variables:
      REGION: us-ashburn-1
      STAGE: pipeline
      OCIR_LOC: "oraclefunctionsdevelopm/test-functions"
      OCIR_REGION: "iad.ocir.io"

inputArtifacts:
  - name: downloadRegctl
    location: ${OCI_WORKSPACE_DIR}/input
    url: https://pipelines.artifactory.us-phoenix-1.oci.oracleiaas.com/faas-release-generic-local/regctl/regctl-linux-arm64
  - name: downloadDockerCredentialOcir
    location: ${OCI_WORKSPACE_DIR}/input
    url: https://pipelines.artifactory.us-phoenix-1.oci.oracleiaas.com/faas-release-generic-local/scripts/docker-credential-ocir
  - name: downloadTestHarness
    location: ${OCI_WORKSPACE_DIR}/input
    url: https://pipelines.artifactory.us-phoenix-1.oci.oracleiaas.com/faas-release-generic-local/fdk-integration-test/fdk-integration-test-${FDK_INTEGRATION_TEST_VERSION}.tar.gz

steps:
  - type: shell
    name: Setup Environment
    command: |
      set -ex

      # docker-credential-ocir is no longer installed from an rpm - we use a script replacement as recommended by OCIR
      cp ${OCI_WORKSPACE_DIR}/input/docker-credential-ocir ${OCI_WORKSPACE_DIR}/docker-credential-ocir
      chmod 755 ${OCI_WORKSPACE_DIR}/docker-credential-ocir

      sudo docker login -u BEARER_TOKEN -p $(echo "${FAAS_OCIR_REGION}" | ${OCI_WORKSPACE_DIR}/docker-credential-ocir get | jq -r .Secret) "${FAAS_OCIR_REGION}"

      cp ${OCI_WORKSPACE_DIR}/input/regctl-linux-arm64 ${OCI_WORKSPACE_DIR}/regctl
      chmod 755 ${OCI_WORKSPACE_DIR}/regctl

      ${OCI_WORKSPACE_DIR}/regctl registry login -u BEARER_TOKEN -p $(echo "${FAAS_OCIR_REGION}" | ${OCI_WORKSPACE_DIR}/docker-credential-ocir get | jq -r .Secret) "${FAAS_OCIR_REGION}"

  - type: shell
    name: Copy base images to OCIR
    command: |
      set -ex
      declare -a dotnet_versions=('3.1' '6.0' '8.0')
      declare -a suffixes=('' '-dev')
      for dotnet in "${dotnet_versions[@]}"; do
          for suffix in "${suffixes[@]}"; do
              src="odo-docker-signed-local.pipelines.artifactory.us-phoenix-1.oci.oracleiaas.com/fdk-dotnet:${dotnet}-${FDK_VERSION}${suffix}"
              dst="${FAAS_OCIR_REGION}/oraclefunctionsdevelopm/test-functions/dotnet:${dotnet}-${FDK_VERSION}${suffix}"
              ${OCI_WORKSPACE_DIR}/regctl image copy -v=DEBUG "$src" "$dst"
          done
      done

  - type: shell
    name: Copy test images to OCIR
    command: |
      set -ex
      function copy_image() {
          local image="$1"
          local dotnet_version="$2"
          local src="odo-docker-signed-local.pipelines.artifactory.us-phoenix-1.oci.oracleiaas.com/faas-${image}:dotnet-${dotnet_version}-${FDK_VERSION}"
          local dst="${FAAS_OCIR_REGION}/oraclefunctionsdevelopm/test-functions/${image}:dotnet${dotnet_version}-${FDK_VERSION}"
          ${OCI_WORKSPACE_DIR}/regctl image copy -v=DEBUG "$src" "$dst"
      }

      copy_image hello-world-fn 3.1
      copy_image oci-sdk-fn 3.1
      copy_image runtime-version-fn 3.1
      copy_image timeout-fn 3.1

      copy_image hello-world-fn 6.0
      copy_image oci-sdk-fn 6.0
      copy_image runtime-version-fn 6.0
      copy_image timeout-fn 6.0

      copy_image hello-world-fn 8.0
      copy_image oci-sdk-fn 8.0
      copy_image runtime-version-fn 8.0
      copy_image timeout-fn 8.0

  - type: shell
    name: Run Integration Test Dotnet 3.1
    command: |
      mkdir -p integration_test_dotnet3.1
      cd integration_test_dotnet3.1
      tar zxvf ${OCI_WORKSPACE_DIR}/input/fdk-integration-test-${FDK_INTEGRATION_TEST_VERSION}.tar.gz .

      CLASSPATH=$(echo *.jar | tr ' ' ':')
      export FDK_RUNTIME=dotnet3.1
      export test=FunctionsIntegrationTest,RuntimeVersionIntegrationTest,OciSdkUsageIntegrationTest
      java -jar junit-platform-console-standalone.jar -cp "$CLASSPATH" --scan-class-path

  - type: shell
    name: Run Integration Test Dotnet 6.0
    command: |
      mkdir -p integration_test_dotnet6.0
      cd integration_test_dotnet6.0
      tar zxvf ${OCI_WORKSPACE_DIR}/input/fdk-integration-test-${FDK_INTEGRATION_TEST_VERSION}.tar.gz .

      CLASSPATH=$(echo *.jar | tr ' ' ':')
      export MULTI_ARCH_ENABLED=True
      export FDK_RUNTIME=dotnet6.0
      export test=FunctionsIntegrationTest,RuntimeVersionIntegrationTest,OciSdkUsageIntegrationTest
      java -jar junit-platform-console-standalone.jar -cp "$CLASSPATH" --scan-class-path

  - type: shell
    name: Run Integration Test Dotnet 8.0
    command: |
      mkdir -p integration_test_dotnet8.0
      cd integration_test_dotnet8.0
      tar zxvf ${OCI_WORKSPACE_DIR}/input/fdk-integration-test-${FDK_INTEGRATION_TEST_VERSION}.tar.gz .

      CLASSPATH=$(echo *.jar | tr ' ' ':')
      export FDK_RUNTIME=dotnet8.0
      export test=FunctionsIntegrationTest,RuntimeVersionIntegrationTest,OciSdkUsageIntegrationTest
      java -jar junit-platform-console-standalone.jar -cp "$CLASSPATH" --scan-class-path
    
  - type: shell
    name: Publish images to public OCIR (Release Only)
    command: |
      set -ex
      if [[ "${RELEASE:-false}" == true ]]; then
        declare -a dotnet_versions=('3.1' '6.0' '8.0')
        declare -a suffixes=('' '-dev')
        for dotnet in "${dotnet_versions[@]}"; do
            for suffix in "${suffixes[@]}"; do
                src="${FAAS_OCIR_REGION}/oraclefunctionsdevelopm/test-functions/dotnet:${dotnet}-${FDK_VERSION}${suffix}"
                dst="${FAAS_OCIR_REGION}/oraclefunctionsdevelopm/fnproject/dotnet:${dotnet}-${FDK_VERSION}${suffix}"
                ${OCI_WORKSPACE_DIR}/regctl image copy -v=DEBUG "$src" "$dst"
            done
        done
      fi